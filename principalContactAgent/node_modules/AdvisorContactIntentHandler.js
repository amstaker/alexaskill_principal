'use strict';

var request = require("request");
var aws = require("aws-lib");

function AdvisorContactIntentHandler(intent, session, response) {
	if(!session.attributes.contactFirstName) {
        session.attributes.question = "contactFirstName";
        response.ask("What is your first name?");
				return;
    }
        if(!session.attributes.contactLastName) {
        session.attributes.question = "contactLastName";
        response.ask("What is your last name?");
				return;
    }
    if(!session.attributes.contactPhoneNumber) {
        session.attributes.question = "contactPhoneNumber";
        response.ask("What is your phone number?");
        // need to add some sort of way to confirm this, also should we ask for email, I'm torn on this question.
				return;
    }
    if(!session.attributes.contactAbout) {
        session.attributes.question = "contactAbout";
        response.ask("What are you calling about?");
				return;
        // this likely should be defined out...
    }
    if(!session.attributes.contactInstantCallback) {
        session.attributes.question = "contactInstantCallback";
        response.ask("Would you like an instant callback? Yes or No?");
				return;
    }
    // If not an instant callback what date and time works?
    if(session.attributes.contactInstantCallback == "no") {
        if(!session.attributes.contactCallbackDate) {
            session.attributes.question = "contactCallbackDate";
            response.ask("What is your preferred callback date?");
						return;
        }
        if(!session.attributes.contactCallbackTime) {
            session.attributes.question = "contactCallbackTime";
            response.ask("What is your preferred callback time?");
						return;
        }
    }

    var emailBody = session.attributes.contactFirstName + " " + session.attributes.contactLastName + " would like to connect with you.";
    emailBody += "Phone Number: " + session.attributes.contactPhoneNumber;
    if(session.attributes.contactInstantCallback == "no") {
        emailBody += "When: " + session.attributes.contactCallbackDate + " at " + session.attributes.contactCallbackTime;
    } else {
        emailBody += "When: Immediately";
    }

    var ses = aws.createSESClient("AKIAJGLMKA4XG24M2ZSQ", "L4gWoVpSWDHBBdXIx1Y6wqfvSuTCG8wEmdh86NQb");

    ses.call("GetSendQuota", {}, function(err, result) {
      console.log(JSON.stringify(result));
    });

    ses.call("GetSendStatistics", {}, function(err, result) {
      console.log(JSON.stringify(result));
    });

    ses.call("ListVerifiedEmailAddresses", {}, function(err, result) {
      console.log(JSON.stringify(result));
    });

    var recipient_address = 'kinit.patel@gmail.com';
    var sender_address = 'kinit.patel@gmail.com';
    var send_args = {
        'Destination.ToAddresses.member.1': recipient_address,
        'Message.Body.Text.Charset': 'UTF-8',
        'Message.Body.Text.Data': emailBody,
        'Message.Body.Html.Charset': 'UTF-8',
        'Message.Body.Html.Data': emailBody,
        'Message.Subject.Charset': 'UTF-8',
        'Message.Subject.Data': 'New Alexa Lead',
        'Source': sender_address
    };
    ses.call('SendEmail', send_args, function(err, result) {
        console.log(result);
    });

    if(session.attributes.contactInstantCallback == "no") {
        response.tell("Thank you. An advisor will reach out to you on " + session.attributes.contactCallbackDate + " at " + session.attributes.contactCallbackTime);
    } else {
        response.tell("Thank you. An advisor will reach out to you soon. Please call us at one eight hundred, nine eight six, three three four three if you need immediate help");
    }


}


exports.respond = AdvisorContactIntentHandler;
